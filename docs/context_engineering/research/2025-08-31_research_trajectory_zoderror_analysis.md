# Research: TrajectoryReconstructor and ZodError Analysis

**Date**: 2025-08-31 17:46:28 UTC
**Repository**: ElizaOS
**Branch**: dynamic-prompting

## Research Question
Why is the TrajectoryReconstructor failing to find trajectory steps and why is a ZodError occurring during scenario execution with missing `evaluator_type`, `summary`, and `details` fields?

## Key Findings

### 1. **TrajectoryReconstructor Room ID Mismatch**
- **Location**: `packages/cli/src/commands/scenario/src/TrajectoryReconstructor.ts:75-85`
- **Description**: The TrajectoryReconstructor detects a mismatch between the expected roomId and the actual roomId where memories are stored
- **Significance**: This causes the reconstructor to look for trajectory data in the wrong location, resulting in 0 steps found

### 2. **Memory Type Mismatch**
- **Location**: `packages/cli/src/commands/scenario/src/TrajectoryReconstructor.ts:90-95`
- **Description**: The reconstructor is looking for `action_result` type memories, but the logs show only `messages` type memories are being created
- **Significance**: The agent is not generating the expected action memory types that the trajectory system expects

### 3. **ZodError: Legacy vs Enhanced Evaluation Format**
- **Location**: `packages/cli/src/commands/scenario/src/conversation-types.ts:75`
- **Description**: The `ConversationResult.finalEvaluations` field expects `EvaluationResult[]` but receives `EnhancedEvaluationResult[]`
- **Significance**: This creates a type mismatch that causes the ZodError when the data aggregator validates the result

### 4. **Data Flow Inconsistency**
- **Location**: `packages/cli/src/commands/scenario/src/LocalEnvironmentProvider.ts:130-140`
- **Description**: The LocalEnvironmentProvider extracts `finalEvaluations` from conversation results and passes them to the data aggregator
- **Significance**: The format conversion between legacy and enhanced evaluation systems is not properly handled

## Architecture Insights

### Current Implementation
- **Patterns**: The system has both legacy (`EvaluationResult`) and enhanced (`EnhancedEvaluationResult`) evaluation formats
- **Integration**: `ConversationManager` uses enhanced evaluations but the data flow expects legacy format
- **Dependencies**: The trajectory system depends on specific memory types that aren't being generated by the agent

### Gaps and Opportunities
- **Missing**: Proper type conversion between evaluation formats in the data flow
- **Improvements**: Agent needs to generate `action_result` memories for trajectory reconstruction
- **Risks**: The current implementation can fail validation even when conversations technically succeed

## Detailed Analysis

### The TrajectoryReconstructor Issue Chain
1. **Room ID Mismatch**: `askAgentViaApi` returns roomId `0137f0e4-d2e2-0ee6-82e5-af58b88ec91b`
2. **Memory Storage**: Memories are actually stored under roomId `f64e48da-668d-0be9-b7a7-3b67643f4b25`
3. **Detection**: TrajectoryReconstructor detects this mismatch and uses the actual roomId
4. **Memory Type Filter**: Only finds `messages` type memories, no `action_result` memories
5. **Result**: 0 trajectory steps found after 3 retry attempts

### The ZodError Issue Chain
1. **ConversationManager**: Uses `runEnhancedEvaluations()` which returns `EnhancedEvaluationResult[]`
2. **Type Definition**: `ConversationResult.finalEvaluations` expects `EvaluationResult[]`
3. **Data Flow**: LocalEnvironmentProvider passes enhanced results to data aggregator
4. **Validation**: `ScenarioRunResultSchema` expects `EnhancedEvaluationResult[]` format
5. **Mismatch**: The actual data doesn't match the expected schema structure

### Memory Analysis from Logs
The logs show the agent is creating memories with this structure:
```json
{
  "text": "Agent response content",
  "simple": true,
  "actions": ["REPLY"],
  "thought": "Agent's internal reasoning",
  "inReplyTo": "message-id",
  "providers": []
}
```

But the TrajectoryReconstructor expects:
```json
{
  "type": "action_result",
  "actionName": "action_name",
  "actionResult": { "success": true }
}
```

## References
- **Files Analyzed**: 
  - `packages/cli/src/commands/scenario/src/TrajectoryReconstructor.ts`
  - `packages/cli/src/commands/scenario/src/ConversationManager.ts`
  - `packages/cli/src/commands/scenario/src/conversation-types.ts`
  - `packages/cli/src/commands/scenario/src/LocalEnvironmentProvider.ts`
  - `packages/cli/src/commands/scenario/src/schema.ts`
  - `packages/cli/src/commands/scenario/src/data-aggregator.ts`
- **Related Research**: Dynamic prompting implementation and evaluation system
- **External Resources**: ElizaOS memory system documentation

## Recommendations

### Immediate Fixes
1. **Type Conversion**: Update `ConversationResult.finalEvaluations` to use `EnhancedEvaluationResult[]` type
2. **Memory Generation**: Ensure the agent generates `action_result` memories during conversation turns
3. **Room ID Consistency**: Fix the room ID mismatch between API calls and memory storage

### Long-term Improvements
1. **Unified Evaluation System**: Consolidate legacy and enhanced evaluation systems
2. **Memory Type Standardization**: Define clear memory types for different agent activities
3. **Trajectory Reconstruction**: Improve the robustness of trajectory reconstruction to handle various memory types

### Testing Strategy
1. **Memory Generation Tests**: Verify that agents generate the expected memory types
2. **Trajectory Reconstruction Tests**: Test with various memory scenarios
3. **Evaluation Format Tests**: Ensure proper format conversion throughout the data flow
